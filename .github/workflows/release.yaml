name: Release

on:
    push:
        branches:
            - publish
jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2

            - name: Create release
              uses: actions/github-script@v4
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const version = require('fs').readFileSync('.version', 'utf8').trim();
                      const { data: release } = await github.repos.createRelease({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        tag_name: 'v' + version,
                        target_commitish: '${{ github.sha }}',
                        name: 'v' + version,
                        draft: false,
                        prerelease: false,
                      });
                      return release.id;
                  result-encoding: string
              id: create-release

            - name: Export library
              run: |
                  git archive -o ./t3dn_bip.zip HEAD:bip/t3dn_bip
                  curl \
                      --data-binary @"t3dn_bip.zip" \
                      -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                      -H "Content-Type: application/octet-stream" \
                      "https://uploads.github.com/repos/${{ github.repository }}/releases/${{ steps.create-release.outputs.result }}/assets?name=t3dn_bip.zip"

            - name: Export examples
              run: |
                  for example in "t3dn_bip_showcase";
                  do
                      git archive -o ./${example}.zip HEAD:example/${example}
                      curl \
                          --data-binary @"${example}.zip" \
                          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                          -H "Content-Type: application/octet-stream" \
                          "https://uploads.github.com/repos/${{ github.repository }}/releases/${{ steps.create-release.outputs.result }}/assets?name=${example}.zip"
                  done
